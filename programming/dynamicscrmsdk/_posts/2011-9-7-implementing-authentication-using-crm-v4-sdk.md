---
layout: post-default
title: Implementing authentication using CRM v4 SDK
date: 2011-9-7 3:50:0 - 0600
PostDate: 2011-9-7
author: apurvghai
category: dynamicscrmsdk
category_title: Dataverse SDK
ag_original_link: https://learn.microsoft.com/en-us/archive/blogs/apurvghai/implementing-authentication-using-crm-v4-sdk
lang: C#
---
<p>

</p>
<div class="blogSite">
<p>This post will talk about the various methods used in authenticating with CRM using its Sdk. I will also explain the usage of each method and property. There are various modes in which authentication in CRM can be performed.</p>
<ol>
<li>Active Directory</li>
<li>Live Authentication</li>
<li>SPLA</li>
</ol>
<p>The below code describes the authentication done with CRM On-Premise version. The connection used in this is <b>Active Directory</b>. I've mentioned the comments before each function and code line which can talk about the action itself. The recommendation is to follow a sequence of the steps as mentioned below.</p>
<p>The function has parameters with NetworkCredentials class, which will take the credentials from your UI Layer (Presentation Layer). I've use a condition to check if you want to hardcode the credentials which implies that the function will use credentials you've provided otherwise it will take current user logged in. It all depends how you want to customize your class.</p>
<div class="sourceCode">
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/// &lt;summary&gt; <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// This function will return the CRM Service Instance for CRM OnPremise - Active Directory<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="networkCredential"&gt;<span class="greenCode">Default Credentials or hard code credentials</span>&lt;/param&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="isUseHardCredential"&gt;<span class="greenCode">Set to True if you want to hard code the credentials</span>&lt;/param&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="isSSL"&gt;<span class="greenCode">Check if the SSL is enabled</span>&lt;/param&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="organizationName"&gt;&lt;/param&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;<span class="greenCode">This returns the instance of CRM Service</span>&lt;/returns&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="functionName">public static</span> <span class="greenCode">CrmService</span> GetCRMServiceInstance(<span class="functionName">NetworkCredential</span> networkCredential, <span class="functionName">bool</span> isUseHardCredential, <span class="functionName">bool</span> isSSL, string organizationName)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Defining the Authentication Token<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">CrmAuthenticationToken</span> token = new <span class="className">CrmAuthenticationToken</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token.AuthenticationType = (<span class="functionName">int</span>)<span class="className">AuthenticationType</span>.ActiveDirectory;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Specify the organizatio Name<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token.OrganizationName = organizationName;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">CrmService</span> crmService = new <span class="className">CrmService</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmService.Credentials = isUseHardCredential ? <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; networkCredential = new <span class="functionName">NetworkCredential</span>("UserName", "Password", "Domain") : CredentialCache.DefaultCredentials;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isSSL)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmService.Url = <span class="functionName">String</span>.Format(<span class="stringData">"{0}://{1}/MSCRMServices/2007/CrmService.asmx", "https", "&lt;&lt;Local URL&gt;&gt;"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmService.Url = String.Format(<span class="stringData">"{0}://{1}/MSCRMServices/2007/CrmService.asmx", "http", "&lt;&lt;Local URL&gt;&gt;"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmService.CrmAuthenticationTokenValue = token;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return crmService;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
</div>
<br />
<p>Coming back to how you can use the <b>Windows Live</b> authentication for CRM to let you in. The steps are pretty much similar which additionally require a function taking care of Windows Live with discovery service. Microsoft has hosted the global URLs for developers to access the CrmSerivce/CrmDiscovery. This is defined in Sdk Guide with complete details. I've tried to explain the procedure with below example. The comments in function will explain you more.</p>
<p>Please note: The Sdk provides the Windows Live authentication wrapper class called "IdCrlWrapper.dll".</p>
<div class="sourceCode">
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/// &lt;summary&gt; <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// <span class="greenCode">This function will return the CRM Service Instance for CRM Online Organization - Live Authentication</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;&lt;/returns&gt;&gt;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="functionName">public static </span><span class="className">CrmService</span> GetCRMServiceInstance()<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="greenCode">//Initialize the discovery service</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discoveryService = new <span class="className">CrmDiscoveryService</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="greenCode">//Get the discovery instance from a function which will connect to Windows Live authentication class. </span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="functionName">this</span>.discoveryService = this.GetDiscoveryInstance();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="greenCode">//Get the ticket response</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">RetrieveCrmTicketRequest</span> crmTicketRequest = new <span class="className">RetrieveCrmTicketRequest</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmTicketRequest.OrganizationName = organizationFriendlyName;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmTicketRequest.PassportTicket = passportTicket;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">RetrieveCrmTicketResponse</span> crmTicketResponse = (<span class="className">RetrieveCrmTicketResponse</span>)discoveryService.Execute(crmTicketRequest);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">CrmAuthenticationToken</span> token = new <span class="className">CrmAuthenticationToken</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token.AuthenticationType = 1;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token.CrmTicket = crmTicketResponse.CrmTicket;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; token.OrganizationName = crmTicketResponse.OrganizationDetail.OrganizationName;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">CrmService</span> crmService = new <span class="className">CrmService</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmService.Url = crmTicketResponse.OrganizationDetail.CrmServiceUrl;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crmService.CrmAuthenticationTokenValue = token;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="functionName">return</span> crmService;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="functionName">public</span> <span class="className">CrmDiscoveryService</span> GetDiscoveryInstance()<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; discoveryService = new <span class="className">CrmDiscoveryService</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; discoveryService.Url = String.Format(<span class="stringData">"https://{0}/MSCRMServices/2007/{1}/CrmDiscoveryService.asmx"</span><span class="sourceCode">,</span><span class="stringData"> "dev.crm.dynamics.com"</span><span class="sourceCode">,</span><span class="stringData"> "Passport"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">RetrievePolicyRequest</span> policyRequest = new <span class="className">RetrievePolicyRequest</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">RetrievePolicyResponse</span> policyResponse = (<span class="className">RetrievePolicyResponse</span>)discoveryService.Execute(policyRequest);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="className">LogonManager</span> logonManager = new <span class="className">LogonManager</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; passportTicket = logonManager.Logon(username,password, organizationFriendlyName + <span class="stringData">".crm.dynamics.com"</span>,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; policyResponse.Policy, environment);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logonManager.Dispose();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="functionName">return</span> discoveryService;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>I've also uploaded the program.cs file for your reference to use windows live authentication.</p>
<p>My next update will cover the SPLA authentication mode.</p>
<p>Cheers,<br /> Apurv</p>
<p><strong>References</strong></p>
<ol>
<li><a href="http://msdn.microsoft.com/en-us/library/cc468422.aspx" target="_blank">How to: Add the CrmDiscoveryService Web Reference: CRM Online</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/cc151014.aspx" target="_blank">How to: Add the CrmService Web Reference: CRM Online</a></li>
</ol></div>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Components.PostAttachments/00/10/20/07/40/Program.zip">Program.zip</a></p>
